---
layout:        post
title:         "Flask Web | Flask 的扩展"
subtitle:      "举例说明 Flask 生态中常见的几种扩展"
author:        "Haauleon"
header-img:    "img/in-post/post-flask/bg.jpeg"
header-mask:   0.4
catalog:       true
tags:
    - Flask
    - Python
    - Web开发
    - Vagrant
    - Ubuntu
---

> 本篇所有操作均在基于 Ubuntu 16.04 LTS 的虚拟机下完成，且使用 Vagrant 来操作虚拟机系统，虚拟机系统 VirtualBox Version: 7.0 

<br>
<br>

### 一、Flask 的扩展
环境准备：     
Python 2.7.11+      
pip==9.0.3     
flask==0.11.1   
httpie==0.9.4     
werkzeug==0.11.10       

&emsp;&emsp;Flask 扩展的生态非常繁荣，这里介绍其中最常用的扩展。    

<br>

#### 1、Flask-Script
&emsp;&emsp;Django 提供了如下管理命令：    
```
> python manage.py startapp
> python manage.py runserver
```

&emsp;&emsp;Flask 也可以通过 Flask-Script 添加运行服务器、设置数据库、定制 shell 等功能的命令。但如果已经使用了 Flask 0.11 版本，可以考虑使用 Flask 自带的命令行接口替代它。      

&emsp;&emsp;使用以下命令行安装 Flask-Script：    
```
> pip2 install flask-script
```

&emsp;&emsp;安装完成后在需要管理的项目根目录下创建一个 manage.py 文件并写入以下内容后保存，即可使用 manage.py 来管理项目：      
```python
# coding=utf-8
"""
在很多地方可能都会看到 from flask.ext.package import X 的用法，但这种用法已经收到了官方反对。
要采用 from flask_script import X 的方式。
"""
from flask_script import Manager, Server, Shell, prompt_bool

from app import app, db, PasteFile

manager = Manager(app)


def make_shell_context():
    return {
        'db': db,
        'PasteFile': PasteFile,
        'app': app
    }


@manager.command
def dropdb():
    if prompt_bool(
            'Are you sure you want to lose all your data'):
        db.drop_all()


@manager.option('-h', '--filehash', dest='filehash')
def get_file(filehash):
    paste_file = PasteFile.query.filter_by(filehash=filehash).first()
    if not paste_file:
        print 'Not exists'
    else:
        print 'URL is {}'.format(paste_file.get_url('i'))


manager.add_command('shell', Shell(make_context=make_shell_context))
manager.add_command('runserver', Server(
    use_debugger=True, use_reloader=True,
    host='0.0.0.0', port=9000)
)


if __name__ == '__main__':
    manager.run()
```

<br>

现在可以使用 manage.py 来管理项目了，输入以下命令行来管理：    
1. 在终端通过 filehash 获取文件路径      
    ```
    (venv) ❯ python2 manage.py get_file -h 8583d66b6b2e467e8c6b586ca428db74.jpg
    URL is http://localhost/i/8583d66b6b2e467e8c6b586ca428db74.jpg

    (venv) ❯ python2 manage.py get_file -h 8583d66b6b2e467e8c6b586ca4hgnnfk.jpg
    Not exists
    ```
2. 在测试环境中可以用来清理数据    
    ```
    (venv) ❯ python2 manage.py dropdb
    Are you sure you want to lose all your data [n]: n
    ```
3. 自带了三个内置变量的 shell     
    ```
    (venv) ❯ python2 manage.py shell

    In [1]: db
    Out[1]: <SQLAlchemy engine='mysql://web:web@localhost:3306/r'>

    In [2]: PasteFile
    Out[2]: models.PasteFile
    ```
4. 通过 manage.py 启动服务    
    ```
    (venv) ❯ python2 manage.py runserver
    * Running on http://0.0.0.0:9000/ (Press CTRL+C to quit)
    * Restarting with stat
    * Debugger is active!
    * Debugger pin code: 203-908-357
    10.0.2.2 - - [21/Dec/2022 06:16:30] "GET / HTTP/1.1" 200 -
    10.0.2.2 - - [21/Dec/2022 06:16:38] "GET / HTTP/1.1" 200 -
    10.0.2.2 - - [21/Dec/2022 06:16:39] "GET / HTTP/1.1" 200 -
    10.0.2.2 - - [21/Dec/2022 06:16:40] "GET / HTTP/1.1" 200 -
    10.0.2.2 - - [21/Dec/2022 06:17:21] "POST / HTTP/1.1" 200 -
    10.0.2.2 - - [21/Dec/2022 06:17:21] "GET /i/dae3aa929d0b4fb4a00d5758cecce502.jpg HTTP/1.1" 200 -
    10.0.2.2 - - [21/Dec/2022 06:20:19] "GET /i/dae3aa929d0b4fb4a00d5758cecce502.jpg HTTP/1.1" 304 -
    ```

&emsp;&emsp;


<br>
<br>

#### 2、Flask-DebugToolbar
&emsp;&emsp;Django 有非常知名的 Django-DebugToolbar，而 Flask 也有对应的替代工具 Flask-DebugToolbar。它会在浏览器上添加右边栏，可以快速查看环境变量、上下文内容，方便调试。     

&emsp;&emsp;使用以下命令行安装 Flask-DebugToolbar：        
```
> pip2 install flask-debugtoolbar
```

&emsp;&emsp;使用它也很简单，但是注意 app.debug 要为 True 才可以看到调试边栏。如下使用示例：    
```python
# coding=utf-8
from flask import Flask
from flask_debugtoolbar import DebugToolbarExtension

app = Flask(__name__)

app.debug = True

app.config['SECRET_KEY'] = 'a secret key'

toolbar = DebugToolbarExtension(app)


@app.route('/')
def hello():
    return '<body></body>'


if __name__ == '__main__':
    app.run(host='0.0.0.0', port=9000, debug=app.debug)
```

浏览器右边栏显示如下图：   
[](\img\in-post\post-flask\2022-12-20-flask-ext-1.jpg)   

<br>
<br>

#### 3、Flask-Migrate
&emsp;&emsp;使用关系型数据库时，修改数据库模型和更新数据库这样的工作时有发生，而且很重要。怎么做到既安全又方便呢？      

&emsp;&emsp;SQLAlchemy 作者为此开发了迁移框架 Alembic，Flask-Migrate 就是基于 Alembic 做了轻量级封装，并集成到 Flask-Script 中。所有操作都通过 Flask-Script 命令完成。它能跟踪数据库结构的变化，把变化的部分应用到数据库中。    

&emsp;&emsp;使用以下命令安装 Flask-Migrate：    
```
> pip2 install Flask-Migrate==1.8.1  
```

&emsp;&emsp;先定义一个 User 类（users.py）：     
```python
# coding=utf-8
from ext import db


class User(db.Model):
    __tablename__ = 'login_users'
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(128), nullable=False)
    login_count = db.Column(db.Integer, default=0)
    last_login_ip = db.Column(db.String(128), default='unknown')
```

&emsp;&emsp;现在在项目根目录下添加迁移支持文件 app_migrate.py 并写入以下内容：      
```python
# coding=utf-8
from flask import Flask
from flask_script import Manager
from flask_migrate import Migrate, MigrateCommand

from ext import db

app = Flask(__name__)
app.config.from_object('config')

db.init_app(app)

import users  # noqa

migrate = Migrate(app, db)
manager = Manager(app)
manager.add_command('db', MigrateCommand)


if __name__ == '__main__':
    manager.run()
```

<br>

我们现在想要在 login_users 表中扩充两个字段 email 和 password，流程如下：    
1. 初始化迁移工作     
    &emsp;&emsp;使用以下命令进行初始化迁移，迁移完成后会在当前目录下增加一个 migrate 目录，这个目录应该放进版本库。    
    ```
    (venv) ❯ python2 app_migrate.py db init
    Creating directory
    /home/ubuntu/web_develop/migrations ... done
    Creating directory
    /home/ubuntu/web_develop/migrations/versions ... done
    Generating /home/ubuntu/web_develop/migrations/script.py.mako ... done
    Generating
    /home/ubuntu/web_develop/migrations/env.pyc ... done
    Generating
    /home/ubuntu/web_develop/migrations/alembic.ini
    ... done
    Generating
    /home/ubuntu/web_develop/migrations/env.py ... done
    Generating
    /home/ubuntu/web_develop/migrations/README ... done
    Please edit configuration/connection/logging settings in '/home/ubuntu/web_develop/migrations/alembic.ini' before proceeding.

    (venv) ❯ ls -al migrations
    total 32
    drwxrwxr-x 3 ubuntu ubuntu 4096 Dec 21 09:57 .
    drwxrwxr-x 6 ubuntu ubuntu 4096 Dec 21 09:57 ..
    -rw-rw-r-- 1 ubuntu ubuntu  770 Dec 21 09:57 alembic.ini
    -rwxrwxr-x 1 ubuntu ubuntu 2883 Dec 21 09:57 env.py
    -rw-rw-r-- 1 ubuntu ubuntu 2734 Dec 21 09:57 env.pyc
    -rwxrwxr-x 1 ubuntu ubuntu   38 Dec 21 09:57 README
    -rwxrwxr-x 1 ubuntu ubuntu  412 Dec 21 09:57 script.py.mako
    drwxrwxr-x 2 ubuntu ubuntu 4096 Dec 21 09:57 versions
    ```
2. 修改 login_users 表的模型结构      
    &emsp;&emsp;给 User 类添加 email 和 password 这两个字段，字段描述如下：     
    ```python
    email = db.Column(db.String(128), nullable=False)
    password = db.Column(db.String(256), nullable=False)
    ```      
3. 创建迁移的脚本    
    &emsp;&emsp;执行以下命令将会在 migration/versions/ 目录下添加一个执行的脚本，文件名就是版本号。版本的对应关系在当前库的 alembic_version 表中。     
    &emsp;&emsp;需要注意的是，假如你的数据库里还有其他的表没有放在迁移脚本中，那么在执行迁移操作时就会从数据库中删掉，所以 app_migrate.py 这样的管理脚本应该覆盖所有重要的表，而所有模型文件中都要使用 `from ext import db`，就可以保证这一点。     
    &emsp;&emsp;创建迁移的脚本这一步其实并没有操作数据库，所以一定要注意终端输出，确定和自己的预想一样。      
    ```
    (venv) ❯ python2 app_migrate.py db migrate
    INFO  [alembic.runtime.migration] Context impl MySQLImpl.
    INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
    INFO  [alembic.autogenerate.compare] Detected removed table u'changes'
    INFO  [alembic.autogenerate.compare] Detected removed table u'change_properties'
    INFO  [alembic.autogenerate.compare] Detected removed table u'buildset_sourcestamps'
    ...
    INFO  [alembic.autogenerate.compare] Detected removed table u'scheduler_changes'
    Generating /home/ubuntu/web_develop/migrations/versions/b75fbc434302_.py ... done
    ```
    &emsp;&emsp;以上创建的迁移脚本 migrations/versions/b75fbc434302_.py 内容部分如下：    
    ```python
    """empty message

    Revision ID: b75fbc434302
    Revises: None
    Create Date: 2022-12-21 10:13:12.074444

    """

    # revision identifiers, used by Alembic.
    revision = 'b75fbc434302'
    down_revision = None

    from alembic import op
    import sqlalchemy as sa
    from sqlalchemy.dialects import mysql

    def upgrade():
        ### commands auto generated by Alembic - please adjust! ###
        op.drop_table('changes')
        op.drop_table('change_properties')
        op.drop_table('buildset_sourcestamps')
        ...
        ...
        ### end Alembic commands ###


    def downgrade():
        ### commands auto generated by Alembic - please adjust! ###
        op.create_table('login_users',
        sa.Column('id', mysql.INTEGER(display_width=11), nullable=False),
        sa.Column('name', mysql.VARCHAR(length=128), nullable=False),
        sa.Column('email', mysql.VARCHAR(length=128), nullable=False),
        sa.Column('password', mysql.VARCHAR(length=256), nullable=False),
        sa.Column('login_count', mysql.INTEGER(display_width=11), autoincrement=False, nullable=True),
        sa.Column('last_login_ip', mysql.VARCHAR(length=128), nullable=True),
        sa.PrimaryKeyConstraint('id'),
        mysql_default_charset=u'latin1',
        mysql_engine=u'InnoDB'
        )
        op.create_table('users',
        sa.Column('id', mysql.INTEGER(display_width=11), nullable=False),
        sa.Column('name', mysql.VARCHAR(length=50), nullable=True),
        sa.PrimaryKeyConstraint('id'),
        mysql_default_charset=u'latin1',
        mysql_engine=u'InnoDB'
        )
        op.create_table('migrate_version',
        sa.Column('repository_id', mysql.VARCHAR(length=250), nullable=False),
        sa.Column('repository_path', mysql.TEXT(), nullable=True),
        sa.Column('version', mysql.INTEGER(display_width=11), autoincrement=False, nullable=True),
        sa.PrimaryKeyConstraint('repository_id'),
        mysql_default_charset=u'latin1',
        mysql_engine=u'MyISAM'
        )
        ...
        ...
        ### end Alembic commands ###
    ```
4. 更新数据库     
    &emsp;&emsp;使用以下命令更新数据库，这一步才是实际操作数据库。        
    ```
    (venv) ❯ python2 app_migrate.py db upgrade
    INFO  [alembic.runtime.migration] Context impl MySQLImpl.
    INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
    INFO  [alembic.runtime.migration] Running upgrade  -> b75fbc434302, empty message
    ```
    &emsp;&emsp;更新后的表结构如下，可以看到这两个字段已经出现了，方便且安全。        
    ```
    mysql> desc login_users;
    +---------------+--------------+------+-----+---------+----------------+
    | Field         | Type         | Null | Key | Default | Extra          |
    +---------------+--------------+------+-----+---------+----------------+
    | id            | int(11)      | NO   | PRI | NULL    | auto_increment |
    | name          | varchar(128) | NO   |     | NULL    |                |
    | email         | varchar(128) | NO   |     | NULL    |                |
    | password      | varchar(256) | NO   |     | NULL    |                |
    | login_count   | int(11)      | YES  |     | NULL    |                |
    | last_login_ip | varchar(128) | YES  |     | NULL    |                |
    +---------------+--------------+------+-----+---------+----------------+
    6 rows in set (0.00 sec)
    ```
5. 取消更新数据库    
    &emsp;&emsp;如果发现有问题也可以很轻松地取消更新，将当前版本降级回退到上一个版本，使用以下命令即可。    
    ```
    (venv) ❯ python2 app_migrate.py db downgrade
    INFO  [alembic.runtime.migration] Context impl MySQLImpl.
    INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
    INFO  [alembic.runtime.migration] Running downgrade b75fbc434302 -> , empty message
    ```    
    &emsp;&emsp;取消更新后表结构也回退到上一个版本。    
    ```
    mysql> desc login_users;
    +---------------+--------------+------+-----+---------+----------------+
    | Field         | Type         | Null | Key | Default | Extra          |
    +---------------+--------------+------+-----+---------+----------------+
    | id            | int(11)      | NO   | PRI | NULL    | auto_increment |
    | name          | varchar(128) | NO   |     | NULL    |                |
    | login_count   | int(11)      | YES  |     | NULL    |                |
    | last_login_ip | varchar(128) | YES  |     | NULL    |                |
    +---------------+--------------+------+-----+---------+----------------+
    4 rows in set (0.00 sec)
    ```

<br>

&emsp;&emsp;上述表结构中的 last_login_ip 在存储 IP 时使用的是字符串类型 varchar，这只是为了展示起来更直观，更好的方法是把 IP 转换为整数。     
```
In [1]: import struct

In [2]: import socket

In [3]: def ip2int(addr):
   ...:     return struct.unpack("!I", socket.inet_aton(addr))[0]
   ...:

In [4]: def int2ip(addr):
   ...:     return socket.inet_ntoa(struct.pack("!I", addr))
   ...:

In [5]: ip2int('10.0.2.2')
Out[5]: 167772674

In [6]: int2ip(167772674)
Out[6]: '10.0.2.2'
```

<br>
<br>

#### 4、Flask-WTF
&emsp;&emsp;Flask-WTF 是一个集成 WTForms 的表单验证和渲染的扩展。     

&emsp;&emsp;使用以下命令安装 Flask-WTF：    
```
> pip2 install Flask-WTF==0.12  
```

&emsp;&emsp;以下通过实现一个注册功能的应用来了解 Flask-WTF 的使用，先定义一个 app_wtf.py 文件并写入以下注册表单的内容：    
```python
from flask_wtf import Form
from wtforms import TextField, PasswordField
from wtforms.validators import length, Required, EqualTo


class RegistrationForm(Form):
    name = TextField('Username', [length(min=4, max=25)])
    email = TextField('Email Address', [length(min=6, max=35)])
    password = PasswordField('New Password', [
        Required(), EqualTo('confirm', message='Passwords must match')
    ])
    confirm = PasswordField('Repeat Password')
```

&emsp;&emsp;应用代码内容如下：   
```python
# coding=utf-8
from flask import Flask, render_template, request
from flask_wtf.csrf import CsrfProtect

from ext import db
from users import User

app = Flask(__name__, template_folder='../../templates')
app.config.from_object('config')
CsrfProtect(app)
db.init_app(app)


@app.route('/register', methods=['GET', 'POST'])
def register():
    form = RegistrationForm(request.form)
    if request.method == 'POST' and form.validate():
        user = User(name=form.name.data, email=form.email.data,
                    password=form.password.data)
        db.session.add(user)
        db.session.commit()
        return 'register successed!'
    return render_template('register.html', form=form)


if __name__ == '__main__':
    app.run(host='0.0.0.0', port=9000, debug=app.debug)
```

&emsp;&emsp;注册模板文件 register.html 的内容如下：    
[](\img\in-post\post-flask\2022-12-20-flask-ext-2.jpg)      

<br>

&emsp;&emsp;这样就完成了一个带有 CSRF 保护的注册表单的功能了，请求结果如下：     
[](\img\in-post\post-flask\2022-12-20-flask-ext-3.jpg)      

<br>
<br>

#### 5、Flask-Security


<br>
<br>

#### 6、Flask-RESTful


<br>
<br>

#### 7、Flask-Admin


<br>
<br>

#### 8、Flask-Assets